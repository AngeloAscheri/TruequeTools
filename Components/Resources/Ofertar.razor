@using TruequeTools.Entities
@using TruequeTools.Data

@inject TruequeToolsDataContext context
@inject IServiciosOferta OfertaService
@inject IJSRuntime JS

@rendermode InteractiveServer

@attribute [Authorize(Roles = "Admin,User")]

<!-- Modal -->
<div class="modal fade" id="ModalOfertar" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog custom-modal-width">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticBackdropLabel">Ofertar en la publicacion #@PublicacionId</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" @onclick="CerrarModal"></button>
            </div>
            <div class="modal-body">
                <ul class="list-group">
                    @if (cargando)
                    {
                        <ul class="d-flex justify-content-center">
                            <div class="spinner-border" role="status">
                                <span class="sr-only"></span>
                            </div>
                        </ul>
                    }
                    else
                    {
                        if (PublicacionActual!.Nombre != null)
                        {
                            context.Entry(PublicacionActual).Reference(p => p.Sucursal).Load();
                            context.Entry(PublicacionActual).Reference(p => p.Usuario).Load();

                            if (PublicacionActual.UsuarioId == UserRequesterId)
                            {
                                <div class="alert alert-danger" role="alert">
                                    No puedes ofertar a una publicacion propia !
                                </div>
                            }
                            else
                            {
                                @if (MisPublicaciones!.Count != 0)
                                {
                                    if (exito)
                                    {
                                        <div>
                                            <div class="alert alert-success" role="alert">
                                                Se registró tu oferta !
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <li class="list-group-item">
                                            <div style="margin-block-start:10px" class="table-responsive">
                                                <h5>Mis Productos</h5>
                                                <table class="table">
                                                    <thead>
                                                        <tr>
                                                            <th>Producto </th>
                                                            <th>Descripción</th>
                                                            <th style="min-width: 120px;"></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var publi in MisPublicaciones) //MUESTRA TODAS LAS PUBLICACIONES CON UN BOTON PARA OFERTAR
                                                        {
                                                            <tr>
                                                                <td>@publi.Nombre</td>
                                                                <td>@publi.Descripcion</td>
                                                                <td style="text-align: right;">
                                                                    <div class="d-flex justify-content-end">
                                                                        <div class="btn-group" style="margin-right: 1rem;">
                                                                            @if (publi.CategoriaId != PublicacionActual.CategoriaId || publi.SucursalId != PublicacionActual.SucursalId)
                                                                            {
                                                                                <i style="margin-block:auto;padding-inline-end: 10%;">Categoria o sucursales diferentes</i>
                                                                                <span class="disabledbutton">
                                                                                    <button class="btn btn-dark rounded" disabled style="margin-right: 0.5rem;">Ofertar</button>
                                                                                </span>
                                                                            }
                                                                            else if (OfertasPublicacionActual!.Where(o => o.PublicacionQueOfertoId == publi.Id).Count() > 0)
                                                                            {
                                                                                <i style="margin-block:auto;padding-inline-end: 10%;">Actualmente ofertado a esta publicación</i>
                                                                                <span class="disabledbutton">
                                                                                    <button class="btn btn-dark rounded" disabled style="margin-right: 0.5rem;">Ofertar</button>
                                                                                </span>
                                                                            }
                                                                            else
                                                                            {
                                                                                <span class="enabledbutton">
                                                                                    <button class="btn btn-dark rounded" @onclick="@(() =>RealizarOferta(publi.Id))" style="margin-right: 0.5rem;">
                                                                                        Ofertar
                                                                                    </button>
                                                                                </span>
                                                                            }
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        </li>
                                    }
                                }
                                else
                                {
                                    <div class="alert alert-warning" role="alert">
                                        No puedes realizar una oferta porque no tienes ningún producto publicado !
                                    </div>
                                }
                            }
                        }
                        else
                        {
                            <div class="alert alert-danger" role="alert">
                                Error: no se encontró o no existe la publicacion seleccionada
                            </div>
                        }
                    }
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    function refreshPage() {
        location.reload();
    }
</script>

@code {

    [Parameter]
    public int PublicacionId { get; set; }
    [Parameter]
    public int UserRequesterId { get; set; }
    [Parameter]
    public Publicacion? PublicacionActual { get; set; }
    [Parameter]
    public List<Publicacion>? MisPublicaciones { get; set; }
    [Parameter]
    public List<Oferta>? OfertasPublicacionActual { get; set; }

    public bool cargando { get; set; }
    public bool exito { get; set; } = false;

    AuthenticationState? authState;

    protected override async Task OnParametersSetAsync()
    {
        cargando = true;
        await Task.Delay(500);
        cargando = false;
    }

    private async void RealizarOferta(int publiId)
    {
        exito = true;
        var oferta = new Oferta
        {
            UsuarioId = UserRequesterId,
            PublicacionQueOfertoId = publiId,
            PublicacionQueOfrezcoId = PublicacionActual!.Id,
            Estado = 0
        };
        await OfertaService.CreateOferta(oferta); 
    }

    public async void CerrarModal()
    {
        if (exito)
        {
            await JS.InvokeVoidAsync("refreshPage");
        }
    }

}
